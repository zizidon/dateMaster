<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ランダムデートプラン共有</title>
	<link rel="stylesheet" href="/css/date_reference/date_reference_list.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
	<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
	<style>
		.share-container {
			max-width: 800px;
			margin: 20px auto;
			padding: 20px;
			background: #fff;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
		}

		.shared-plan {
			margin: 20px 0;
			padding: 15px;
			background: #f8f9fa;
			border-radius: 4px;
		}

		.spot-details {
			margin: 10px 0;
			padding: 10px;
			border-bottom: 1px solid #dee2e6;
			display: flex;
			align-items: start;
			gap: 20px;
		}

		.spot-image {
			width: 120px;
			height: 120px;
			overflow: hidden;
			border-radius: 4px;
		}

		.spot-image img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.spot-info {
			flex: 1;
		}

		.bottom-buttons {
			display: flex;
			justify-content: center;
			gap: 20px;
			margin-top: 20px;
		}

		.button-style {
			padding: 10px 20px;
			border: none;
			border-radius: 4px;
			background-color: #007bff;
			color: white;
			cursor: pointer;
			transition: background-color 0.3s;
		}

		.button-style:hover {
			background-color: #0056b3;
		}

		#map {
			height: 400px;
			width: 100%;
			margin: 20px 0;
			border-radius: 8px;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			display: none;
		}

		.location-selector {
			margin: 20px 0;
			text-align: center;
			display: none;
		}

		.location-selector select {
			padding: 8px 12px;
			font-size: 16px;
			border-radius: 4px;
			border: 1px solid #ddd;
			margin-left: 10px;
		}
	</style>
</head>

<body>
	<header>
		<h1><a th:href="@{/dateMaster/home}">DatingMaster</a></h1>
	</header>

	<main>
		<div class="share-container">
			<h2>ランダムデートプラン共有</h2>

			<!-- 出発地点選択 -->
			<div class="location-selector" id="locationSelector">
				<label for="start-location">出発地点を選択:</label>
				<select id="start-location">
					<option value="kagoshima-chuo">鹿児島中央駅</option>
					<option value="kagoshima">鹿児島駅</option>
					<option value="tenmonkan">天文館</option>
					<option value="taniyama">谷山駅</option>
					<option value="kagoshima-airport">鹿児島空港</option>
				</select>
			</div>

			<!-- 共有されたプラン表示部分 -->
			<div th:if="${sharedPlan}" class="shared-plan">
				<h3>パートナーから共有されたプラン</h3>
				<p th:text="'共有日時: ' + ${#temporals.format(sharedPlan.createdAt, 'yyyy/MM/dd HH:mm')}"></p>

				<div th:each="spot : ${spots}" class="spot-details">
					<div class="spot-image">
						<img th:src="@{/spot_images/{name}.jpg(name=${spot.spotName})}" alt="スポット画像">
					</div>
					<div class="spot-info">
						<div><strong>スポット名:</strong> <span th:text="${spot.spotName}"></span></div>
						<div><strong>カテゴリー:</strong> <span th:text="${spot.categoryName}"></span></div>
						<div><strong>住所:</strong> <span th:text="${spot.spotAddress}"></span></div>

					</div>
				</div>
			</div>

			<div id="map"></div>

			<div class="bottom-buttons">
				<button type="button" onclick="location.href='/dateMaster/sharedRandomPlanMap'"
					class="button-style">マップで参照</button>
				<button type="button" onclick="history.back()" class="button-style">戻る</button>
			</div>
		</div>
	</main>

	<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
	<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
	<script th:inline="javascript">
		const spots = /*[[${spots}]]*/[];
		let map;
		let routeControl;

		// 地点情報の定義
		const locations = {
			"kagoshima-chuo": {
				lat: 31.5837,
				lng: 130.5412,
				name: "鹿児島中央駅"
			},
			"kagoshima": {
				lat: 31.601668833428423,
				lng: 130.56298412289036,
				name: "鹿児島駅"
			},
			"tenmonkan": {
				lat: 31.59125465657467,
				lng: 130.55504199999436,
				name: "天文館"
			},
			"taniyama": {
				lat: 31.5267,
				lng: 130.5187,
				name: "谷山駅"
			},
			"kagoshima-airport": {
				lat: 31.8031,
				lng: 130.7219,
				name: "鹿児島空港"
			}
		};

		document.getElementById('showMapButton').addEventListener('click', function () {
			const mapDiv = document.getElementById('map');
			const locationSelector = document.getElementById('locationSelector');
			mapDiv.style.display = 'block';
			locationSelector.style.display = 'block';

			if (!map) {
				initializeMap();
			}
		});

		document.getElementById('start-location').addEventListener('change', function () {
			updateRoute();
		});

		function initializeMap() {
			const selectedLocation = locations[document.getElementById('start-location').value];

			map = L.map('map').setView([selectedLocation.lat, selectedLocation.lng], 13);

			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);

			updateRoute();
		}

		function updateRoute() {
			if (routeControl) {
				map.removeControl(routeControl);
			}

			const selectedLocation = locations[document.getElementById('start-location').value];

			// 出発地点のウェイポイントを追加
			const waypoints = [
				L.latLng(selectedLocation.lat, selectedLocation.lng)
			];

			// スポットのウェイポイントを追加
			spots.forEach(spot => {
				waypoints.push(L.latLng(spot.latitude, spot.longitude));
			});

			if (waypoints.length > 1) {
				routeControl = L.Routing.control({
					waypoints: waypoints,
					routeWhileDragging: false,
					lineOptions: {
						styles: [{color: '#4299e1', opacity: 0.6, weight: 4}]
					},
					createMarker: function (i, waypoint, n) {
						let markerContent;
						if (i === 0) {
							markerContent = `<b>${selectedLocation.name}</b><br>出発地点`;
						} else {
							const spot = spots[i - 1];
							markerContent = `<b>${spot.spotName}</b><br>${spot.spotAddress}<br>${spot.description}`;
						}
						return L.marker(waypoint.latLng).bindPopup(markerContent);
					},
					show: false,
					addWaypoints: false,
					draggable: false
				}).addTo(map);
			}
		}
	</script>
</body>

</html>